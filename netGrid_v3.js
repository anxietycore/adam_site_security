(()=>{try{const d=7,s=Math.min(window.devicePixelRatio||1,1.5),h=300,g={r:6,g:160,b:118},y={r:136,g:68,b:255},f=40,u=45,x=.05,m=[[3,0],[4,0],[5,1],[3,2],[4,2],[5,2],[2,3],[3,3],[5,3],[1,4],[2,4],[4,4],[0,5],[1,5],[0,6]];function e(){const e=new Set,t=[];for(let o=0;o<m.length;o++){let o,a,n;do{o=Math.floor(Math.random()*d),a=Math.floor(Math.random()*d),n=`${o},${a}`}while(e.has(n));e.add(n),t.push([o,a])}return t}let p=e();const v=document.createElement("canvas");Object.assign(v.style,{position:"fixed",right:"20px",bottom:"20px",width:`${h}px`,height:`${h}px`,pointerEvents:"none",zIndex:f,borderRadius:"8px",boxShadow:"0 18px 40px rgba(0,0,0,0.9)",backgroundColor:"rgba(0,10,6,0.28)",cursor:"default"}),document.body.appendChild(v);const b=v.getContext("2d"),M=document.createElement("div");Object.assign(M.style,{position:"fixed",left:"18px",bottom:"12px",fontFamily:"'Press Start 2P', monospace, Courier",fontSize:"11px",color:`rgba(${g.r}, ${g.g}, ${g.b}, 1)`,textShadow:`0 0 10px rgba(${g.r}, ${g.g}, ${g.b}, 0.9)`,zIndex:u,pointerEvents:"none",userSelect:"none",letterSpacing:"0.6px",fontWeight:"700",opacity:"1",lineHeight:"1.4"}),document.body.appendChild(M);let k=0,w=0,S=[],C=[],T=null,_=0,$=null,F=!1,G=0,A=0;const R={play:(e,t={})=>{try{if(e.endsWith(".mp3")){const o=new Audio(`sounds/${e}`);return o.volume=void 0!==t.volume?t.volume:.7,t.playbackRate&&(o.playbackRate=t.playbackRate),o.play().catch((()=>{})),o}const o=[`sounds/grid/${e}.wav`,`sounds/grid/${e}.mp3`,`sounds/grid/${e}`];for(let e of o)try{const o=new Audio(e);return o.volume=void 0!==t.volume?t.volume:.7,t.playbackRate&&(o.playbackRate=t.playbackRate),o.play().catch((()=>{})),o}catch(e){}return null}catch(e){return null}}};function t(e=1,t=!1){const o=t?y:g;return`rgba(${o.r},${o.g},${o.b},${e})`}function o(e=1){return`rgba(255,60,60,${e})`}function a(){const e=h,t=h;v.style.width=e+"px",v.style.height=t+"px",k=v.width=Math.floor(e*s),w=v.height=Math.floor(t*s),function(){S=[];const e=15*s,t=k-2*e,o=w-2*e;for(let a=0;a<d;a++){const n=[];for(let l=0;l<d;l++){const r=e+l/(d-1)*t,i=e+a/(d-1)*o;n.push({x:r,y:i})}S.push(n)}}(),function(){if(0===C.length)n();else for(const e of C)e.x=S[e.gy][e.gx].x,e.y=S[e.gy][e.gx].y,e.targetGx=e.gx,e.targetGy=e.gy}()}function n(){C=p.map(((e,t)=>{const[o,a]=e,n=S[a][o];return{id:t,gx:o,gy:a,x:n.x,y:n.y,targetGx:o,targetGy:a,locked:!1,selected:!1,lastMove:0}})),$=null}function l(){if(!F)return void(M.textContent=`[СЕТЬ: НЕАКТИВНА] | ДЕГРАДАЦИЯ: ${G}%`);const e=$?`УЗЕЛ: ${$.id} [${$.gx},${$.gy}]`:"УЗЕЛ: НЕ ВЫБРАН",t=C.filter((e=>e.locked)).length,o=t===m.length?"КЛЮЧ: СОБРАН":"КЛЮЧ: НЕ СОБРАН";M.innerHTML=`[РЕЖИМ СЕТКИ] | ${e} | ${o}<br>\n[WASD/↑↓←→] Движение | [Space] Закрепить/Открепить (${t}/${m.length}) | [Tab] Выбор | [ESC] Выход`}function r(e,t){if(!$||$.locked)return;if(A>93&&Math.random()<.4)return $.selected=!1,$=C[Math.floor(Math.random()*C.length)],$.selected=!0,M.textContent="⚠ ОШИБКА: УЗЕЛ ЗАБЛОКИРОВАН СИСТЕМОЙ",void setTimeout(l,1500);const o=Math.max(0,Math.min(d-1,$.gx+e)),a=Math.max(0,Math.min(d-1,$.gy+t));if(C.some((e=>e!==$&&e.locked&&e.gx===o&&e.gy===a)))return M.textContent="⚠ КООРДИНАТА ЗАНЯТА",void setTimeout(l,1e3);$.gx=o,$.gy=a,$.targetGx=o,$.targetGy=a,l()}function i(){if(!$)return;if(A>93&&Math.random()<.4)return $.selected=!1,$=C[Math.floor(Math.random()*C.length)],$.selected=!0,M.textContent="⚠ ОШИБКА: УЗЕЛ ЗАБЛОКИРОВАН СИСТЕМОЙ",void setTimeout(l,1500);$.locked=!$.locked,G=Math.max(0,Math.min(100,G+1));const e=C.filter((e=>e.locked)).length;e===m.length&&setTimeout((()=>{const t=window.__netGrid.checkSolution();t.solved?(window.__TerminalCanvas&&(window.__TerminalCanvas.addColoredText(">>> КЛЮЧ ПОДОШЁЛ <<<","#00FF41"),R.play("interface_key_success",{volume:.5}),window.__TerminalCanvas.addColoredText("> Доступ к сектору OBSERVER-7 открыт","#FFFF00")),function(){let e=0;const t=setInterval((()=>{C.forEach((e=>e.selected=!e.selected)),e++,e>=6&&(clearInterval(t),C.forEach((e=>e.selected=!1)),$=null)}),100)}(),G=Math.max(0,G-15),A=Math.max(0,A-10)):(window.__TerminalCanvas&&(window.__TerminalCanvas.addColoredText("> Конфигурация не соответствует протоколу","#FF4444"),window.__TerminalCanvas.addColoredText(`> Правильных узлов: ${t.correct}/${t.total} | Неправильных: ${e-t.correct}`,"#FFFF00")),G=Math.min(100,G+2),window.degradation&&window.degradation.addDegradation(2))}),500)}function c(){b.save(),b.setTransform(1,0,0,1,0,0),b.globalAlpha=1,b.globalCompositeOperation="source-over",b.clearRect(0,0,k,w),b.restore(),function(){const e=Date.now(),t=A;t>=80&&C.forEach((e=>{e.locked&&(e.locked=!1)}));for(const o of C){if(o.selected||o.locked||t>=90&&t<100){o.targetGx=o.gx,o.targetGy=o.gy;continue}const a=t>80?.3:.1,n=t>80?300:1500;if(e-o.lastMove>n&&Math.random()<a){const t=[[0,1],[1,0],[0,-1],[-1,0],[1,1],[-1,-1],[1,-1],[-1,1]],[a,n]=t[Math.floor(Math.random()*t.length)],l=Math.max(0,Math.min(d-1,o.gx+a)),r=Math.max(0,Math.min(d-1,o.gy+n));C.some((e=>e!==o&&e.locked&&e.gx===l&&e.gy===r))||(o.targetGx=l,o.targetGy=r,o.lastMove=e)}}for(const e of C){const o=S[e.targetGy][e.targetGx].x,a=S[e.targetGy][e.targetGx].y;t>=90&&t<100?(e.x=o+15*(Math.random()-.5),e.y=a+15*(Math.random()-.5)):(e.x+=(o-e.x)*x,e.y+=(a-e.y)*x),Math.hypot(o-e.x,a-e.y)<1&&(e.gx=e.targetGx,e.gy=e.targetGy)}}(),_++,A<80?function(){b.save(),b.setTransform(1,0,0,1,0,0),b.globalAlpha=1,b.clearRect(0,0,k,w),b.fillStyle="rgba(2,18,12,0.66)",b.beginPath(),b.roundRect(0,0,k,w,8*s),b.fill();const e=b.createRadialGradient(k/2,w/2,.06*Math.min(k,w),k/2,w/2,.9*Math.max(k,w));e.addColorStop(0,"rgba(0,0,0,0)"),e.addColorStop(1,"rgba(0,0,0,0.14)"),b.fillStyle=e,b.fillRect(0,0,k,w),b.strokeStyle=t(.1,!1),b.lineWidth=1*s,b.beginPath();for(let e=0;e<d;e++){const t=S[0][e].x;b.moveTo(t,S[0][0].y),b.lineTo(t,S[d-1][0].y)}for(let e=0;e<d;e++){const t=S[e][0].y;b.moveTo(S[0][0].x,t),b.lineTo(S[0][d-1].x,t)}b.stroke(),b.save(),b.lineCap="round";for(let e=0;e<C.length;e++)for(let o=e+1;o<C.length;o++){const a=C[e],n=C[o],l=Math.hypot(a.x-n.x,a.y-n.y);if(l<.32*k){const e=Math.max(.1,.32-l/(.9*k)*.22),o=b.createLinearGradient(a.x,a.y,n.x,n.y);o.addColorStop(0,t(e,!1)),o.addColorStop(1,t(.45*e,!1)),b.strokeStyle=o,b.lineWidth=1*s,b.beginPath(),b.moveTo(a.x,a.y),b.lineTo(n.x,n.y),b.stroke()}}b.restore();for(const e of C){e.selected||e.locked;const a=2.2*s+(e.selected?1.6*s:0);b.beginPath(),b.fillStyle=e.locked?o(1):t(1,!1),b.arc(e.x,e.y,a,0,2*Math.PI),b.fill(),b.beginPath(),b.lineWidth=1*s,b.strokeStyle=e.selected?"#FFFFFF":e.locked?o(.92):t(.92,!1),b.arc(e.x,e.y,a+1.2*s,0,2*Math.PI),b.stroke()}b.font=10*s+"px monospace",b.fillStyle=t(.95,!1),b.textAlign="right",b.fillText("BIOCODE",k-8*s,12*s),b.restore()}():function(e){const a={globalAlpha:1,rotation:0,breatheScale:1,nodeScale:1,pulseIntensity:.5,isVignetteActive:!0};if(e>=80&&e<85&&(a.globalAlpha=.85+.15*Math.sin(.1*_)),e>=85&&e<90&&(a.rotation=.3*Math.sin(.002*_)*Math.PI/180),e>=90&&e<95&&(a.breatheScale=1+.05*Math.sin(.005*_)),e>=95&&(a.globalAlpha=Math.max(.3,1-(e-95)/5),a.isVignetteActive=!1),a.isVignetteActive){const e=b.createRadialGradient(k/2,w/2,.06*Math.min(k,w),k/2,w/2,.9*Math.max(k,w));e.addColorStop(0,"rgba(0,0,0,0)"),e.addColorStop(1,"rgba(0,0,0,0.14)"),b.fillStyle=e,b.fillRect(0,0,k,w)}b.save(),1!==a.globalAlpha&&(b.globalAlpha=a.globalAlpha),0!==a.rotation&&(b.translate(k/2,w/2),b.rotate(a.rotation),b.translate(-k/2,-w/2)),1!==a.breatheScale&&(b.translate(k/2,w/2),b.scale(a.breatheScale,a.breatheScale),b.translate(-k/2,-w/2)),b.strokeStyle=t(.1,!0),b.lineWidth=1*s,b.beginPath();for(let e=0;e<d;e++){const t=S[0][e].x;b.moveTo(t,S[0][0].y),b.lineTo(t,S[d-1][0].y)}for(let e=0;e<d;e++){const t=S[e][0].y;b.moveTo(S[0][0].x,t),b.lineTo(S[0][d-1].x,t)}b.stroke(),b.restore(),b.save(),b.lineCap="round";for(let e=0;e<C.length;e++)for(let o=e+1;o<C.length;o++){const a=C[e],n=C[o],l=Math.hypot(a.x-n.x,a.y-n.y);if(l<.32*k){const e=Math.max(.1,.32-l/(.9*k)*.22),o=b.createLinearGradient(a.x,a.y,n.x,n.y);o.addColorStop(0,t(e,!0)),o.addColorStop(1,t(.45*e,!0)),b.strokeStyle=o,b.lineWidth=1*s,b.beginPath(),b.moveTo(a.x,a.y),b.lineTo(n.x,n.y),b.stroke()}}b.restore();for(const n of C){e>=85&&e<90&&(a.nodeScale=.8+.2*Math.sin(.01*_+n.id)),e>=80&&e<95&&(a.pulseIntensity=.5+.5*Math.sin(1.2*(n.id+.02*_)));const l=n.selected?1.4:n.locked?1.2:1,r=(6*s+3*a.pulseIntensity*s)*l*a.nodeScale,i=n.locked?o(.36*l):t(.36*l,!0),c=n.locked?o(.12*l):t(.12*l,!0),d=b.createRadialGradient(n.x,n.y,0,n.x,n.y,r);d.addColorStop(0,i),d.addColorStop(.6,c),d.addColorStop(1,"rgba(0,0,0,0)"),b.fillStyle=d,b.fillRect(n.x-r,n.y-r,2*r,2*r),b.beginPath();const h=(2.2*s+(n.selected?1.6*s:0))*a.nodeScale;b.fillStyle=n.locked?o(1):t(1,!0),b.arc(n.x,n.y,h,0,2*Math.PI),b.fill(),b.beginPath(),b.lineWidth=1*s,b.strokeStyle=n.selected?"#FFFFFF":n.locked?o(.92):t(.92,!0),b.arc(n.x,n.y,h+1.2*s,0,2*Math.PI),b.stroke()}b.font=10*s+"px monospace",b.fillStyle=t(.95,!0),b.textAlign="right",b.fillText("BIOCODE",k-8*s,12*s)}(A)}window.__netGrid={setGridMode(e){F=e,v.style.pointerEvents=e?"auto":"none",e&&!$&&C.length>0?($=C[0],$.selected=!0):!e&&$&&($.selected=!1,$=null),l()},isGridMode:()=>F,checkSolution(){const e=C.filter((e=>e.locked));if(0===e.length)return{solved:!1,total:m.length,correct:0,lockedCount:0};let t=0;for(let o=0;o<m.length;o++){const[a,n]=m[o];e.find((e=>e.gx===a&&e.gy===n))&&t++}return{solved:t===m.length,total:m.length,correct:t,lockedCount:e.length}},addDegradation:e=>{G=Math.max(0,Math.min(100,G+Math.round(e)))},setSystemDegradation:e=>{A=e,e<80&&(v.style.filter="",v.style.transform="",v.style.opacity="1")},getDegradation:()=>G,forceReset(){A=0,G=0,_=0,p=e(),n(),v.style.pointerEvents="none",v.style.filter="",v.style.transform="",v.style.opacity="1",document.querySelectorAll("#glitchLayer, #cursorLayer").forEach((e=>{e&&e.parentNode&&e.remove()}))}},document.addEventListener("keydown",(e=>{if(F)switch(e.key){case"Tab":e.preventDefault(),R.play("grid_select",{volume:.5}),e.shiftKey?function(){if(!$||0===C.length)return;const e=C.indexOf($),t=0===e?C.length-1:e-1;$.selected=!1,$=C[t],$.selected=!0,l()}():function(){if(!$||0===C.length)return;const e=(C.indexOf($)+1)%C.length;$.selected=!1,$=C[e],$.selected=!0,l()}();break;case" ":e.preventDefault(),$&&($.locked?R.play("grid_unlock",{volume:.6}):R.play("grid_lock",{volume:.6})),i();break;case"Escape":window.__netGrid.setGridMode(!1),window.__TerminalCanvas&&(R.play("interface_mode_to_terminal",{volume:.4}),window.__TerminalCanvas.addColoredText("> Выход из режима сетки","#00FF41"));break;case"w":case"ц":case"ArrowUp":e.preventDefault(),R.play("grid_move",{volume:.4}),r(0,-1);break;case"s":case"ы":case"ArrowDown":e.preventDefault(),R.play("grid_move",{volume:.4}),r(0,1);break;case"a":case"ф":case"ArrowLeft":e.preventDefault(),R.play("grid_move",{volume:.4}),r(-1,0);break;case"d":case"в":case"ArrowRight":e.preventDefault(),R.play("grid_move",{volume:.4}),r(1,0)}})),window.addEventListener("resize",a),a(),T=requestAnimationFrame((function e(){_++,c(),T=requestAnimationFrame(e)}))}catch(E){}})();
