<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>7x7 — 15 точек | Символы</title>
<style>
  :root{--pad:20;--cell:60;--size:460}
  body{font-family:Inter, system-ui, sans-serif;background:#0b0b0b;color:#dfe;display:flex;min-height:100vh;margin:0}
  .wrap{margin:auto;display:flex;gap:24px;padding:24px;align-items:flex-start}
  .panel{width:340px;background:#07110a;border:1px solid #184; padding:14px;border-radius:8px}
  h1{font-size:18px;margin:6px 0 10px}
  p.small{font-size:12px;color:#9fb}
  .canvas{background:#06110a;padding:18px;border-radius:8px;border:1px solid #183}
  svg{background:#020202;border-radius:4px;display:block}
  .controls{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  .preset-btn{display:flex;align-items:flex-start;gap:8px;padding:8px;background:#062018;border:1px solid #183;color:#bff;border-radius:6px;cursor:pointer}
  .preset-btn:hover{background:#083023}
  .preset-name{font-weight:700}
  .preset-desc{font-size:12px;color:#99b;margin-top:4px}
  .row{display:flex;gap:8px;align-items:center}
  .points-list{margin-top:12px;max-height:220px;overflow:auto;padding-right:6px}
  .pt-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px}
  .dot{width:16px;height:16px;border-radius:50%;background:#ffea57;box-shadow:0 0 10px rgba(255,234,87,.4)}
  .locked{outline:2px solid #f55}
  button.small{padding:6px 8px;border-radius:6px;border:1px solid #184;background:#072; color:#dfe;cursor:pointer}
  .footer{margin-top:12px;font-size:12px;color:#9fb}
  .top-actions{display:flex;gap:8px;margin-bottom:8px}
  .toggle{display:flex;align-items:center;gap:8px}
  a.link{color:#8ff;font-size:13px}
  .credits{font-size:11px;color:#678;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>7×7 сетка — 15 точек</h1>
    <p class="small">Тяни жёлтые точки по узлам сетки, фиксируй их галочкой. 20 пресетов — нажми кнопку, точки станут в указанные места. Есть режим: "учесть закрепления".</p>

    <div class="top-actions">
      <button id="resetBtn" class="small">Сброс</button>
      <button id="randomBtn" class="small">Рандом</button>
      <button id="exportBtn" class="small">Экспорт JSON</button>
    </div>

    <div class="toggle">
      <label><input type="checkbox" id="respectLocks" checked> Учитывать закрепления при применении пресетов</label>
    </div>

    <div class="points-list" id="pointsList"></div>
    <div class="footer">Подсказка: клик по точке — выбрать, двойной клик — закрепить/открепить. Нажми и тяни, точки прилипают к узлам.</div>
    <div class="credits">Сгенерировано ассистентом — 20 символов (мифы/религия/космос).<br>Нажми кнопку пресета, чтобы применить.</div>
  </div>

  <div class="canvas">
    <svg id="svg" width="460" height="460" viewBox="0 0 460 460"></svg>
    <div style="margin-top:10px;max-height:620px;overflow:auto;">
      <div id="presets" class="controls"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const SVG_SIZE = 460;
  const PAD = 20; // padding
  const CEL = 60; // cell size (6 cells -> 7 nodes)
  const N = 7; // nodes per side
  const POINTS = 15;

  // helper: map grid (1..7,1..7 where y=1 bottom) -> svg coords
  function nodeToXY(x,y){
    const sx = PAD + (x-1)*CEL;
    const sy = PAD + (N - y)*CEL; // invert y
    return {sx,sy};
  }

  const svg = document.getElementById('svg');

  // draw grid
  function drawGrid(){
    svg.innerHTML = '';
    // background
    const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x',0);bg.setAttribute('y',0);bg.setAttribute('width',SVG_SIZE);bg.setAttribute('height',SVG_SIZE);bg.setAttribute('fill','#010202');
    svg.appendChild(bg);

    // outer border
    const border = document.createElementNS('http://www.w3.org/2000/svg','rect');
    border.setAttribute('x',PAD-6);border.setAttribute('y',PAD-6);border.setAttribute('width',CEL*(N-1)+12);border.setAttribute('height',CEL*(N-1)+12);
    border.setAttribute('stroke','#133');border.setAttribute('fill','none');border.setAttribute('stroke-width',2);
    svg.appendChild(border);

    // grid lines
    for(let i=0;i<N;i++){
      const x = PAD + i*CEL;
      const y = PAD + i*CEL;
      const l1 = document.createElementNS('http://www.w3.org/2000/svg','line');
      l1.setAttribute('x1',PAD); l1.setAttribute('y1',y); l1.setAttribute('x2',PAD + (N-1)*CEL); l1.setAttribute('y2',y);
      l1.setAttribute('stroke','#093'); l1.setAttribute('stroke-width',2); l1.setAttribute('opacity',0.18);
      svg.appendChild(l1);
      const l2 = document.createElementNS('http://www.w3.org/2000/svg','line');
      l2.setAttribute('y1',PAD); l2.setAttribute('x1',x); l2.setAttribute('y2',PAD + (N-1)*CEL); l2.setAttribute('x2',x);
      l2.setAttribute('stroke','#093'); l2.setAttribute('stroke-width',2); l2.setAttribute('opacity',0.18);
      svg.appendChild(l2);
    }

    // small nodes
    for(let y=1;y<=N;y++) for(let x=1;x<=N;x++){
      const {sx,sy} = nodeToXY(x,y);
      const n = document.createElementNS('http://www.w3.org/2000/svg','circle');
      n.setAttribute('cx',sx); n.setAttribute('cy',sy); n.setAttribute('r',3); n.setAttribute('fill','#064'); n.setAttribute('opacity',0.8);
      svg.appendChild(n);
    }
  }

  drawGrid();

  // 20 presets (names+desc+coords array of 15 [x,y])
  const PRESETS = [
    {name:'Усечённый Иггдрасиль', desc:'Древо миров — ствол, корни и два асимметричных ветвления (страж-портал).', coords:[ [4,1],[4,2],[4,3],[4,4],[4,5],[3,4],[2,5],[1,6],[5,4],[6,5],[7,6],[3,1],[5,1],[2,2],[6,2] ]},
    {name:'Прерванный Уроборос', desc:'Кольцо жизни, не смыкающееся — разрыв цикла, разлом времени.', coords:[ [2,7],[3,7],[4,7],[5,7],[6,7],[7,6],[7,5],[6,5],[6,1],[5,1],[4,1],[1,2],[1,3],[1,4],[2,2] ]},
    {name:'Пирамида Пяти', desc:'Пирамида из уровней — путь вверх через пять ступеней бытия.', coords:[ [4,7],[3,6],[5,6],[2,5],[4,5],[6,5],[1,4],[3,4],[5,4],[7,4],[1,3],[2,3],[3,3],[4,3],[5,3] ]},
    {name:'Искажение Анкха', desc:'Ключ жизни с «глазом» в петле — проход охраняется и шифрует имя.', coords:[ [3,7],[4,7],[5,7],[3,6],[5,6],[4,6],[2,5],[3,5],[4,5],[5,5],[6,5],[4,4],[4,3],[4,2],[4,1] ]},
    {name:'Пирамида Глаза', desc:'Пирамида с всевидящим глазом и тремя корнями под ней — культ наблюдения.', coords:[ [4,7],[3,6],[5,6],[2,5],[4,5],[6,5],[1,4],[3,4],[5,4],[7,4],[4,6],[4,4],[3,2],[4,1],[5,2] ]},

    {name:'Звезда Давида и Катакомбы', desc:'Слияние геометрии звезды и подземных путей — тайна за семью печатями.', coords:[ [4,7],[2,5],[6,5],[1,3],[7,3],[2,1],[6,1],[3,6],[5,6],[3,2],[5,2],[4,4],[2,4],[6,4],[4,1] ]},
    {name:'Лунный Серп', desc:'Полумесяц, указывающий на скрытые циклы и переходы между реальностями.', coords:[ [6,7],[5,7],[4,7],[3,6],[2,5],[2,4],[3,3],[4,2],[5,2],[6,2],[7,3],[7,4],[6,5],[5,6],[7,6] ]},
    {name:'Отпечаток Пустоты', desc:'Спираль/слизень вокруг центра — символ поглощения и обратных зеркал.', coords:[ [4,7],[5,6],[6,5],[7,4],[6,3],[5,2],[4,1],[3,2],[2,3],[1,4],[2,5],[3,6],[4,5],[4,4],[4,3] ]},
    {name:'Космический Оррей', desc:'Осевая система с внешними орбитами — модель небесного устройства.', coords:[ [1,7],[7,7],[1,1],[7,1],[4,7],[4,1],[1,4],[7,4],[2,6],[6,6],[2,2],[6,2],[3,4],[5,4],[4,4] ]},
    {name:'Трисмегист — Тройной Ключ', desc:'Три ключа/треугольника переплетены — алхимический шифр.', coords:[ [2,7],[4,6],[6,7],[1,5],[3,4],[5,5],[7,3],[2,3],[4,2],[6,3],[3,1],[5,1],[4,4],[1,7],[7,1] ]},

    {name:'Херувимские Крылья', desc:'Крылья вокруг центра — стражи на пороге, разделяют миры.', coords:[ [1,7],[2,6],[3,6],[2,5],[1,4],[3,4],[1,3],[2,2],[3,1],[5,7],[6,6],[7,6],[6,5],[5,4],[7,4] ]},
    {name:'Книга Судеб', desc:'Три столба — записи поступков; центральный спиннинг — судья.', coords:[ [2,7],[2,5],[2,3],[2,1],[4,7],[4,6],[4,5],[4,4],[4,3],[4,2],[6,7],[6,5],[6,3],[6,1],[4,1] ]},
    {name:'Мандала Хаоса', desc:'Центр и кольцо — медитация и разлад одновременно.', coords:[ [4,7],[4,6],[5,6],[6,5],[6,4],[5,4],[4,4],[3,4],[2,4],[2,5],[3,6],[2,3],[3,2],[5,2],[6,3] ]},
    {name:'Пентаграмма Скрытых Судеб', desc:'Пятеричный шифр, разбросанный по сети — уроки запретной геометрии.', coords:[ [4,7],[2,6],[6,6],[1,4],[7,4],[2,2],[6,2],[3,5],[5,5],[4,3],[3,1],[5,1],[1,6],[7,6],[4,5] ]},
    {name:'Колокол Освящения', desc:'Форма колокола и язычок — зов, что отзывается в подземном.', coords:[ [3,7],[4,7],[5,7],[2,6],[6,6],[2,5],[6,5],[2,4],[6,4],[3,3],[4,2],[5,3],[1,3],[7,3],[4,1] ]},

    {name:'Небесный Компас', desc:'Вертикаль и диагонали — направление, которое читают посвящённые.', coords:[ [4,7],[4,6],[4,5],[4,4],[4,3],[4,2],[4,1],[1,4],[2,5],[3,6],[5,6],[6,5],[7,4],[2,3],[6,3] ]},
    {name:'Рейки-Сигил', desc:'Квадраты и стержни — защитный печатный знак.', coords:[ [2,7],[4,7],[6,7],[2,5],[4,5],[6,5],[2,3],[4,3],[6,3],[1,6],[7,6],[1,2],[7,2],[4,4],[4,1] ]},
    {name:'Код Атлантов', desc:'Дубль-волна с якорем — след древних карт и маршрутов.', coords:[ [1,6],[2,5],[3,6],[4,5],[5,6],[6,5],[7,6],[4,4],[3,3],[5,3],[2,2],[6,2],[1,1],[7,1],[4,1] ]},
    {name:'Семя Бога', desc:'Спираль роста — зарождение узора жизни.', coords:[ [4,7],[5,7],[6,6],[6,5],[5,5],[4,5],[3,4],[3,3],[2,3],[2,2],[1,2],[1,1],[4,4],[5,3],[6,4] ]},
    {name:'Шляпа Провидца', desc:'Треугольная шляпа с линией зрения — знак провидения и ориентира.', coords:[ [3,7],[4,6],[5,7],[2,5],[6,5],[1,3],[7,3],[3,4],[5,4],[4,5],[4,4],[4,3],[2,2],[6,2],[4,1] ]},

    // +50 additional presets
    {name:'Зеркало Морро', desc:'Зеркальная диагональ — врата отражений и двойников.', coords:[ [1,7],[2,6],[3,5],[4,4],[5,3],[6,2],[7,1],[1,1],[2,2],[3,3],[5,5],[6,6],[7,7],[4,7],[4,1] ]},
    {name:'Астролябия', desc:'Сеть малых орбит вокруг центра — карта звёздных дорог.', coords:[ [4,7],[3,6],[5,6],[2,5],[6,5],[1,4],[7,4],[2,3],[6,3],[3,2],[5,2],[4,4],[1,7],[7,1],[4,1] ]},
    {name:'Крест Двенадцати', desc:'Крест с ответвлениями — дюжина врат, по одному на месяц.', coords:[ [4,7],[4,6],[4,5],[4,4],[4,3],[4,2],[4,1],[3,4],[2,4],[5,4],[6,4],[1,4],[7,4],[3,6],[5,6] ]},
    {name:'Рунический Ворон', desc:'Фигура ворона в полёте — вестник и память предков.', coords:[ [1,7],[2,6],[3,6],[4,5],[5,5],[6,4],[7,4],[5,3],[3,3],[2,2],[1,1],[7,1],[6,2],[4,3],[2,4] ]},
    {name:'Кольцо Семи', desc:'Семь точек кольцом и вспомогательные якоря — клятва семи.', coords:[ [2,7],[4,7],[6,7],[1,5],[7,5],[2,3],[6,3],[4,6],[4,4],[3,5],[5,5],[3,2],[5,2],[1,1],[7,1] ]},
    {name:'Лабиринт Посвящённых', desc:'Ветки, ведущие к центру — путь, который не совпадает с дорогой назад.', coords:[ [1,7],[2,7],[3,6],[4,5],[3,4],[2,4],[1,3],[2,2],[3,1],[5,1],[6,2],[7,3],[6,4],[5,5],[4,6] ]},
    {name:'Близнецы Ойкумена', desc:'Парные символы по сторонам — дихотомия власти.', coords:[ [1,7],[1,5],[1,3],[1,1],[7,7],[7,5],[7,3],[7,1],[4,7],[4,1],[2,6],[2,2],[6,6],[6,2],[4,4] ]},
    {name:'Глаз Океана', desc:'Центр окружён концентрическими слоями — наблюдение из глубины.', coords:[ [4,7],[3,6],[5,6],[2,5],[6,5],[1,4],[7,4],[3,2],[5,2],[2,3],[6,3],[4,6],[4,5],[4,3],[4,1] ]},
    {name:'Сигил Дельфинов', desc:'Изломанные дуги — благословение моря и пути рыб.', coords:[ [2,7],[3,6],[4,5],[5,4],[6,3],[5,2],[4,1],[3,2],[2,3],[1,4],[2,5],[3,6],[4,4],[6,5],[7,6] ]},
    {name:'Оружие Солнца', desc:'Лучистая фигура — символ власти и разрушения.', coords:[ [4,7],[4,6],[4,5],[3,5],[5,5],[2,6],[6,6],[1,7],[7,7],[2,4],[6,4],[3,3],[5,3],[4,2],[4,1] ]},

    {name:'Печать Небесного Охотника', desc:'Треугольники и клин — следы охоты в небе.', coords:[ [3,7],[5,7],[2,6],[4,6],[6,6],[1,5],[7,5],[3,4],[5,4],[2,3],[6,3],[3,2],[5,2],[4,1],[4,5] ]},
    {name:'Алатырь', desc:'Центральный камень и радиальные тропы — сердцевина мира.', coords:[ [4,7],[4,6],[4,5],[4,4],[3,4],[5,4],[2,4],[6,4],[1,4],[7,4],[4,3],[4,2],[4,1],[2,6],[6,6] ]},
    {name:'Кираж Звёзд', desc:'Диагональные созвездия, будто видимые только в определённые ночи.', coords:[ [1,7],[3,6],[5,5],[7,4],[5,3],[3,2],[1,1],[7,7],[6,6],[4,6],[2,5],[2,3],[4,2],[6,1],[4,4] ]},
    {name:'Шифр Асмодея', desc:'Раздвоенные петли и кресты — оккультный код для доверенных.', coords:[ [2,7],[3,7],[5,7],[6,7],[4,6],[2,5],[6,5],[3,4],[5,4],[2,3],[6,3],[3,2],[5,2],[4,1],[4,5] ]},
    {name:'Пульсар', desc:'Синкопированное излучение — центры и волны.', coords:[ [4,7],[4,6],[4,5],[3,5],[5,5],[2,5],[6,5],[3,3],[5,3],[2,2],[6,2],[1,4],[7,4],[4,3],[4,1] ]},

    {name:'Рог Изобилия', desc:'Изломанная воронка с раздачей по краям — благословение и цена.', coords:[ [5,7],[6,6],[7,5],[6,4],[5,3],[4,2],[3,1],[2,2],[1,3],[2,4],[3,5],[4,6],[5,5],[6,3],[4,4] ]},
    {name:'Алтарь Пяти', desc:'Пять точек вокруг центральной — жертвоприношение и пятёрок.', coords:[ [4,7],[3,6],[5,6],[2,5],[4,5],[6,5],[1,4],[3,4],[5,4],[7,4],[4,3],[3,2],[5,2],[2,1],[6,1] ]},
    {name:'Мечтатель Млечного Пути', desc:'Две диагонали и центр — меч, направленный в Галактику.', coords:[ [1,7],[2,6],[3,5],[4,4],[5,3],[6,2],[7,1],[7,7],[6,6],[5,5],[3,3],[2,2],[1,1],[4,7],[4,1] ]},
    {name:'Око Монохрома', desc:'Глаз, лишённый цвета — наблюдение без чувства.', coords:[ [4,7],[3,6],[5,6],[2,5],[6,5],[1,4],[7,4],[4,6],[4,5],[4,3],[3,2],[5,2],[2,2],[6,2],[4,1] ]},
    {name:'Торговец Судеб', desc:'Решётка и весы — сделки и записанные долги.', coords:[ [2,7],[4,7],[6,7],[2,5],[4,5],[6,5],[2,3],[4,3],[6,3],[1,6],[7,6],[1,2],[7,2],[3,4],[5,4] ]},
    {name:'Молекула Сриты', desc:'Органическая сеть — рукопись природы и её запретов.', coords:[ [3,7],[4,7],[5,7],[2,6],[6,6],[1,5],[7,5],[3,4],[5,4],[2,3],[6,3],[3,2],[5,2],[4,1],[4,5] ]},
    {name:'Кольцо Инкарнаций', desc:'Повторяющаяся петля — счета прожитых жизней.', coords:[ [2,7],[3,6],[4,5],[5,4],[6,3],[5,2],[4,1],[3,2],[2,3],[1,4],[2,5],[3,6],[4,4],[5,6],[6,6] ]},

    {name:'Плавник Времени', desc:'Наклонная форма со встроенным якорем — время как рыба.', coords:[ [1,6],[2,5],[3,5],[4,4],[5,4],[6,3],[7,3],[4,7],[4,1],[2,3],[6,3],[3,2],[5,2],[1,1],[7,1] ]},
    {name:'Капище Теней', desc:'Густая сеть у основания — место, где тени собираются.', coords:[ [1,7],[2,6],[3,5],[3,4],[2,3],[1,2],[4,4],[5,5],[6,6],[7,7],[7,1],[6,2],[5,3],[4,2],[4,1] ]},
    {name:'Пусть Будет', desc:'Простой крест с дополнениями — акт утверждения.', coords:[ [4,7],[4,6],[4,5],[4,4],[4,3],[4,2],[4,1],[3,4],[5,4],[2,4],[6,4],[1,4],[7,4],[3,6],[5,6] ]},
    {name:'Мост Великих', desc:'Линия перехода с опорами по краям — путь для избранных.', coords:[ [1,7],[2,7],[3,7],[4,7],[5,7],[6,7],[7,7],[1,1],[7,1],[4,4],[2,5],[6,5],[3,3],[5,3],[4,1] ]},
    {name:'Сердце Мира', desc:'Сжатая форма в центре — ядро, пульсирующее меж узлов.', coords:[ [4,6],[3,5],[5,5],[2,4],[6,4],[4,5],[4,4],[3,3],[5,3],[2,2],[6,2],[1,4],[7,4],[4,7],[4,1] ]},
    {name:'Камертон', desc:'Резонатор — линии, совпадающие на определённых узлах.', coords:[ [2,7],[3,6],[4,5],[5,6],[6,7],[4,7],[4,6],[1,4],[7,4],[2,3],[6,3],[3,2],[5,2],[4,4],[4,1] ]},

    {name:'След Титанова', desc:'Мощная диагональ с подпорками — отпечаток гиганта.', coords:[ [1,7],[2,6],[3,5],[4,4],[5,3],[6,2],[7,1],[1,1],[2,2],[3,3],[5,5],[6,6],[7,7],[4,7],[4,1] ]},
    {name:'Паутина Пастыря', desc:'Сложная сетка, удерживающая и указывающая.', coords:[ [1,7],[1,5],[1,3],[1,1],[7,7],[7,5],[7,3],[7,1],[4,7],[4,1],[2,4],[3,4],[5,4],[6,4],[4,4] ]},
    {name:'Ритуал Трёх', desc:'Три точки вверху, три внизу — консолидация сил.', coords:[ [2,7],[4,7],[6,7],[2,1],[4,1],[6,1],[3,5],[5,5],[3,3],[5,3],[1,4],[7,4],[4,4],[4,6],[4,2] ]},
    {name:'Хоровод Лун', desc:'Кольцевая композиция с подвижными ритмами.', coords:[ [2,7],[3,6],[4,7],[5,6],[6,7],[7,6],[1,6],[2,5],[6,5],[3,4],[5,4],[4,3],[1,4],[7,4],[4,1] ]},
    {name:'Руна Порога', desc:'Простая, но мощная — пункт входа и запрета.', coords:[ [3,7],[4,7],[5,7],[3,5],[5,5],[3,3],[5,3],[2,4],[6,4],[1,4],[7,4],[4,6],[4,4],[4,2],[4,1] ]},

    {name:'Сеть Провидца', desc:'Тонкая сеть для улавливания образов судеб.', coords:[ [2,7],[3,7],[4,6],[5,6],[6,5],[5,4],[4,4],[3,4],[2,3],[1,2],[7,2],[6,3],[5,2],[4,1],[4,5] ]},
    {name:'Рассказчик Звёзд', desc:'Память созвездий, записанная в узлах.', coords:[ [1,7],[3,6],[5,5],[7,4],[6,3],[4,3],[2,3],[1,1],[7,1],[2,5],[6,5],[3,2],[5,2],[4,7],[4,1] ]},
    {name:'Храм Семи Колонн', desc:'Симметричный ряд столбов и центр — служение.', coords:[ [2,7],[2,5],[2,3],[2,1],[4,7],[4,5],[4,3],[4,1],[6,7],[6,5],[6,3],[6,1],[1,4],[7,4],[4,4] ]},
    {name:'Врата Сцен', desc:'Ряд эшелонов — проходы, которые меняют то, кто идёт через них.', coords:[ [1,7],[2,6],[3,5],[4,4],[5,3],[6,2],[7,1],[1,1],[2,2],[3,3],[5,5],[6,6],[7,7],[4,7],[4,1] ]},
    {name:'Последний Корабль', desc:'Форма корабля с мачтой — путешествие в вечность.', coords:[ [2,6],[3,6],[4,6],[5,6],[6,6],[4,7],[4,5],[3,4],[5,4],[2,3],[6,3],[1,2],[7,2],[4,1],[4,4] ]},
    {name:'Гармоника Сфер', desc:'Ритмичные точки, настроенные друг к другу.', coords:[ [1,7],[3,7],[5,7],[7,7],[2,5],[4,5],[6,5],[2,3],[4,3],[6,3],[1,1],[3,1],[5,1],[7,1],[4,4] ]}
  ];

  // create preset buttons
  const presetsRoot = document.getElementById('presets');
  PRESETS.forEach((p,idx)=>{
    const btn = document.createElement('div');
    btn.className = 'preset-btn';
    btn.title = p.desc;
    const inner = document.createElement('div');
    inner.innerHTML = `<div class="preset-name">${idx+1}. ${p.name}</div><div class="preset-desc">${p.desc}</div>`;
    btn.appendChild(inner);
    btn.addEventListener('click',()=>applyPreset(idx,false));
    // right-click to override locks
    btn.addEventListener('contextmenu',e=>{e.preventDefault(); applyPreset(idx,true);});
    presetsRoot.appendChild(btn);
  });

  // points state
  const points = [];
  for(let i=0;i<POINTS;i++){
    points.push({id:i+1,x:Math.floor(1+Math.random()*7),y:Math.floor(1+Math.random()*7),locked:false});
  }

  // ensure uniqueness initial - snap duplicates by nudging
  function ensureUnique(){
    const seen = new Set();
    points.forEach(pt=>{
      let key = pt.x+','+pt.y; let tries=0;
      while(seen.has(key) && tries<20){
        pt.x = Math.floor(1+Math.random()*7); pt.y = Math.floor(1+Math.random()*7);
        key = pt.x+','+pt.y; tries++;
      }
      seen.add(key);
    });
  }
  ensureUnique();

  // create point svg elements and list
  const pointElems = [];
  const linesGroup = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(linesGroup);
  const dotsGroup = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(dotsGroup);

  function render(){
    // clear groups
    linesGroup.innerHTML=''; dotsGroup.innerHTML='';
    // draw connecting polyline (optional) - draw straight thin lines in the order of points
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
    poly.setAttribute('fill','none'); poly.setAttribute('stroke','#ffd'); poly.setAttribute('stroke-opacity',0.04); poly.setAttribute('stroke-width',2);
    const pts = points.map(p=>{const c=nodeToXY(p.x,p.y);return c.sx+','+c.sy;}).join(' ');
    poly.setAttribute('points',pts);
    linesGroup.appendChild(poly);

    // points
    points.forEach((p,i)=>{
      const {sx,sy} = nodeToXY(p.x,p.y);
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('data-id',p.id);
      g.setAttribute('transform',`translate(${sx},${sy})`);

      // halo
      const halo = document.createElementNS('http://www.w3.org/2000/svg','circle');
      halo.setAttribute('r',12); halo.setAttribute('fill','none'); halo.setAttribute('stroke','#ffe066'); halo.setAttribute('stroke-opacity',0.12);
      g.appendChild(halo);

      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r',8); c.setAttribute('fill','#ffea57'); c.setAttribute('stroke','#000'); c.setAttribute('stroke-width',1);
      if(p.locked) c.setAttribute('stroke','#f55');
      g.appendChild(c);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('y',26); label.setAttribute('text-anchor','middle'); label.setAttribute('font-size',10); label.setAttribute('fill','#9fb');
      label.textContent = p.id;
      g.appendChild(label);

      dotsGroup.appendChild(g);

      // events
      g.style.cursor = p.locked ? 'not-allowed' : 'grab';
      g.addEventListener('pointerdown', e=>startDrag(e,i));
      g.addEventListener('dblclick', e=>{ points[i].locked = !points[i].locked; render(); updateList(); });
      g.addEventListener('click', e=>selectIndex(i));

      pointElems[i]=g;
    });
    updateList();
  }

  let selectedIndex = null;
  function selectIndex(i){ selectedIndex = i; updateList(); }

  function updateList(){
    const root = document.getElementById('pointsList'); root.innerHTML='';
    points.forEach((p,i)=>{
      const el = document.createElement('div'); el.className='pt-item';
      el.style.justifyContent='space-between';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
      const dot = document.createElement('div'); dot.className='dot'; if(p.locked) dot.classList.add('locked');
      left.appendChild(dot);
      const txt = document.createElement('div'); txt.innerHTML=`<strong>#${p.id}</strong> &nbsp; (${p.x},${p.y})`;
      left.appendChild(txt);
      el.appendChild(left);
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      const lock = document.createElement('input'); lock.type='checkbox'; lock.checked = p.locked; lock.addEventListener('change',()=>{p.locked=lock.checked; render();});
      right.appendChild(lock);
      const snapBtn = document.createElement('button'); snapBtn.className='small'; snapBtn.textContent='Центр'; snapBtn.addEventListener('click',()=>{ snapToNearest(i); });
      right.appendChild(snapBtn);
      el.appendChild(right);
      el.addEventListener('click',()=>{ selectIndex(i); });
      if(i===selectedIndex) el.style.background='linear-gradient(90deg, rgba(255,255,0,0.04), transparent)';
      root.appendChild(el);
    });
  }

  function snapToNearest(i){
    // snap to nearest grid node
    const {sx,sy} = nodeToXY(points[i].x, points[i].y);
    points[i].x = clamp(Math.round(points[i].x),1,7);
    points[i].y = clamp(Math.round(points[i].y),1,7);
    render();
  }

  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

  // dragging
  let dragging = null;
  function startDrag(e,index){
    if(points[index].locked) return;
    dragging = {index};
    svg.setPointerCapture(e.pointerId);
    const g = pointElems[index];
    g.setAttribute('opacity',0.9);
    g.style.cursor='grabbing';
    document.addEventListener('pointermove', onDrag);
    document.addEventListener('pointerup', endDrag);
  }
  function onDrag(e){
    if(!dragging) return;
    const pt = svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
    const ctm = svg.getScreenCTM().inverse(); const loc = pt.matrixTransform(ctm);
    // limit inside grid area
    const min = PAD-12; const max = PAD + (N-1)*CEL +12;
    const x = clamp(loc.x,min,max); const y = clamp(loc.y,min,max);
    const g = pointElems[dragging.index];

    g.setAttribute('transform',`translate(${x},${y})`);
    // compute nearest node for preview
    // map back to logical x,y
    const lx = Math.round((x - PAD)/CEL) + 1;
    const ly = N - Math.round((y - PAD)/CEL);
    // don't mutate until release
    points[dragging.index]._preview = {x: clamp(lx,1,7), y: clamp(ly,1,7)};
    updateListPreview();
  }
  function updateListPreview(){
    const root = document.getElementById('pointsList');
    if(!root) return;
    // refresh minimal: show preview coords for selected
    for(let i=0;i<points.length;i++){
      const p = points[i];
      // find text node
      const el = root.children[i]; if(!el) continue;
      const txt = el.querySelector('div > div:nth-child(2)');
      if(txt){
        const prev = p._preview ? ` → (${p._preview.x},${p._preview.y})` : '';
        txt.innerHTML = `<strong>#${p.id}</strong> &nbsp; (${p.x},${p.y})` + prev;
      }
    }
  }
  function endDrag(e){
    if(!dragging) return;
    const i = dragging.index; const g = pointElems[i];
    g.setAttribute('opacity',1); g.style.cursor='grab';
    // apply preview
    if(points[i]._preview){ points[i].x = points[i]._preview.x; points[i].y = points[i]._preview.y; delete points[i]._preview; }
    document.removeEventListener('pointermove', onDrag);
    document.removeEventListener('pointerup', endDrag);
    dragging = null; render();
  }

  // apply preset (index) - if override true then move locked points too, otherwise respect locks checkbox
  function applyPreset(idx,forceOverride){
    const p = PRESETS[idx];
    const respect = document.getElementById('respectLocks').checked;
    const override = forceOverride || !respect;
    // take preset coords array of length 15
    for(let i=0;i<POINTS;i++){
      const target = p.coords[i];
      if(!target) continue;
      if(points[i].locked && !override) continue;
      points[i].x = target[0]; points[i].y = target[1];
    }
    render();
  }

  // reset / random
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    // place 15 points evenly in a diagonal-ish initial
    const seed = [ [1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[1,7],[7,1],[2,6],[6,2],[3,5],[5,3],[4,7],[4,1] ];
    for(let i=0;i<POINTS;i++){ points[i].x=seed[i][0]; points[i].y=seed[i][1]; points[i].locked=false; }
    render();
  });
  document.getElementById('randomBtn').addEventListener('click', ()=>{
    for(let i=0;i<POINTS;i++){ if(points[i].locked) continue; points[i].x = Math.floor(1+Math.random()*7); points[i].y = Math.floor(1+Math.random()*7); }
    // ensure uniqueness roughly
    const seen = new Set(); points.forEach(pt=>{ let key=pt.x+','+pt.y; let tries=0; while(seen.has(key)&&tries<10){ pt.x=Math.floor(1+Math.random()*7); pt.y=Math.floor(1+Math.random()*7); key=pt.x+','+pt.y; tries++; } seen.add(key); });
    render();
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const out = points.map(p=>({id:p.id,x:p.x,y:p.y,locked:p.locked}));
    const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='points.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // initial render
  render();

  // click on svg empty space deselect
  svg.addEventListener('click', e=>{ if(e.target===svg) { selectedIndex=null; updateList(); }});

  // keyboard: arrow keys nudge selected
  window.addEventListener('keydown', e=>{
    if(selectedIndex==null) return;
    const p = points[selectedIndex]; if(p.locked) return;
    if(e.key==='ArrowUp') p.y = Math.min(7,p.y+1);
    if(e.key==='ArrowDown') p.y = Math.max(1,p.y-1);
    if(e.key==='ArrowLeft') p.x = Math.max(1,p.x-1);
    if(e.key==='ArrowRight') p.x = Math.min(7,p.x+1);
    render();
  });

})();
</script>
</body>
</html>
