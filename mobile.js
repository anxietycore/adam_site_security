(()=>{"use strict";const e=56;class t{constructor(e){this.mobile=e,this.isOpen=!1,this.element=null,this.callback=null}show(e,t){this.isOpen&&this.hide(),this.isOpen=!0,this.callback=t,this.element=document.createElement("div"),this.element.id="confirmationPanel",this.element.className="selection-panel confirmation-panel",this.element.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: rgba(1, 8, 6, 0.97);\n        border: 2px solid rgba(0, 255, 65, 0.15);\n        border-radius: 12px;\n        padding: 8px;\n        z-index: 99999;\n        min-width: 280px;\n        max-width: 90vw;\n        font-family: 'Press Start 2P', monospace;\n        color: #00FF41;\n      ";const n=document.createElement("div");n.style.cssText="font-size: 11px; margin-bottom: 10px; text-align: center; color: #FFFF00; padding-bottom: 8px; border-bottom: 1px solid #00FF41;",n.textContent=e,this.element.appendChild(n);const s=document.createElement("div");s.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;";const i=document.createElement("button");i.className="submenu-item",i.textContent="Y",i.style.color="#00FF41",i.style.borderColor="rgba(0, 255, 65, 0.25)",i.addEventListener("click",(()=>{this.mobile.playSound("click");const e=this.callback;this.hide(),e&&e(!0)})),s.appendChild(i);const a=document.createElement("button");a.className="submenu-item",a.textContent="N",a.style.color="#FF4444",a.style.borderColor="rgba(255, 80, 80, 0.25)",a.addEventListener("click",(()=>{this.mobile.playSound("close");const e=this.callback;this.hide(),e&&e(!1)})),s.appendChild(a),this.element.appendChild(s),document.body.appendChild(this.element),this.escHandler=e=>{if("Escape"===e.key){const e=this.callback;this.hide(),e&&e(!1)}},document.addEventListener("keydown",this.escHandler)}hide(){this.isOpen&&(this.isOpen=!1,this.callback=null,this.element&&(this.element.remove(),this.element=null),document.removeEventListener("keydown",this.escHandler))}}class n{constructor(e){this.mobile=e,this.isOpen=!1,this.element=null}show(e,t,n){this.isOpen&&this.hide(),this.isOpen=!0,this.element=document.createElement("div"),this.element.id="selectionPanel",this.element.className="selection-panel",this.element.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: rgba(1, 8, 6, 0.97);\n        border: 2px solid rgba(0, 255, 65, 0.15);\n        border-radius: 12px;\n        padding: 8px;\n        z-index: 99999;\n        min-width: 280px;\n        max-width: 90vw;\n        max-height: 60vh;\n        overflow-y: auto;\n        font-family: 'Press Start 2P', monospace;\n        color: #00FF41;\n      ";const s=document.createElement("div");s.style.cssText="font-size: 11px; margin-bottom: 10px; text-align: center; color: #FFFF00; padding-bottom: 8px; border-bottom: 1px solid #00FF41;",s.textContent=t,this.element.appendChild(s);const i=document.createElement("div");i.style.cssText="display: flex; flex-direction: column; gap: 6px;";const a=document.createElement("div");a.style.cssText="display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px;";const l=document.createElement("div");l.style.cssText="display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px;";const o=e.slice(0,8),d=e.slice(8);o.forEach((e=>{const t=document.createElement("button");t.className="submenu-item",t.textContent=e.label,e.description&&(t.innerHTML+=`<div style="font-size: 8px; color: #888; margin-top: 4px;">${e.description}</div>`),t.addEventListener("click",(()=>{this.mobile.playSound("click");const t=n;this.hide(),t(e.value)})),a.appendChild(t)})),d.forEach((e=>{const t=document.createElement("button");t.className="submenu-item",t.textContent=e.label,e.description&&(t.innerHTML+=`<div style="font-size: 8px; color: #888; margin-top: 4px;">${e.description}</div>`),t.addEventListener("click",(()=>{this.mobile.playSound("click");const t=n;this.hide(),t(e.value)})),l.appendChild(t)}));const c=document.createElement("button");c.className="submenu-item",c.style.color="#FF4444",c.style.borderColor="rgba(255, 80, 80, 0.25)",c.textContent="ОТМЕНА",c.addEventListener("click",(()=>{this.mobile.playSound("close"),this.hide(),this.mobile.addInputLine()})),0===d.length?a.appendChild(c):l.appendChild(c),i.appendChild(a),(d.length>0||l.children.length>0)&&i.appendChild(l),this.element.appendChild(i),document.body.appendChild(this.element),this.escHandler=e=>{"Escape"===e.key&&(this.hide(),this.mobile.addInputLine())},document.addEventListener("keydown",this.escHandler)}hide(){this.isOpen&&(this.isOpen=!1,this.element&&(this.element.remove(),this.element=null),document.removeEventListener("keydown",this.escHandler))}}class s{constructor(e){this.mobile=e,this.isOpen=!1,this.element=null}show(){this.isOpen&&this.hide(),this.isOpen=!0,this.element=document.createElement("div"),this.element.id="numericKeypad",this.element.className="numeric-keypad",this.element.style.cssText="\n    position: fixed;\n    bottom: 20px;\n    left: 50%;\n    transform: translateX(-50%);\n    background: rgba(0, 0, 0, 0.95);\n    border: 2px solid rgba(0, 255, 65, 0.2);\n    border-radius: 14px;\n    padding: 12px;\n    z-index: 99998;\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 8px;\n    min-width: 280px;\n    max-width: 90vw;\n  ";this.mobile;for(let e=1;e<=9;e++){const t=this.createButton(e.toString(),(()=>this.sendKey(e.toString())));this.element.appendChild(t)}const e=this.createButton("0",(()=>this.sendKey("0")));this.element.appendChild(e);const t=this.createButton("⌫",(()=>this.sendKey("Backspace")));t.style.color="#FFFF00",t.style.borderColor="rgba(255, 255, 0, 0.25)",this.element.appendChild(t);const n=this.createButton("⏎",(()=>this.sendKey("Enter")));n.style.color="#00FF41",n.style.borderColor="rgba(0, 255, 65, 0.25)",this.element.appendChild(n);const s=document.createElement("div");s.style.visibility="hidden",this.element.appendChild(s);const i=document.createElement("div");i.style.visibility="hidden",this.element.appendChild(i);const a=this.createButton("ESC",(()=>{this.hide(),setTimeout((()=>this.sendKey("Escape")),50)}));a.style.color="#FF4444",a.style.borderColor="rgba(255, 80, 80, 0.25)",a.style.gridColumn="1 / -1",this.element.appendChild(a),document.body.appendChild(this.element)}createButton(e,t){const n=document.createElement("button");return n.textContent=e,n.style.cssText="\n        min-height: 54px;\n        background: rgba(0, 0, 0, 0.6);\n        color: #00FF41;\n        border: 1px solid rgba(0, 255, 65, 0.15);\n        border-radius: 8px;\n        font-size: 14px;\n        cursor: pointer;\n        font-family: 'Press Start 2P', monospace;\n      ",n.onclick=()=>{this.mobile.playSound("click"),t()},n}sendKey(e){this.mobile.playSound("click");const t=new KeyboardEvent("keydown",{key:e,bubbles:!0});document.dispatchEvent(t)}hide(){this.isOpen&&(this.isOpen=!1,this.element&&(this.element.remove(),this.element=null))}}class i{constructor(){this.state={isInitialized:!1,apiReady:!1,commands:[],dossierIds:[]},this.elements={},this.api={},this.selectionPanel=new n(this),this.numericKeypad=new s(this),this.confirmationPanel=new t(this)}async start(){this.cacheElements(),await this.waitForApi(),await this.loadData(),this.generateUI(),this.hideNetGridInitially(),this.setupDecryptListener(),this.state.isInitialized=!0}cacheElements(){const e={sidePanel:"sidePanel",panelContent:"panelContent",panelHandle:"panelHandle",gridModal:"gridModal",mapContainer:"mapContainer",keyboard:"virtualKeyboard"};for(const[t,n]of Object.entries(e))this.elements[t]=document.getElementById(n)}async waitForApi(){return new Promise((e=>{let t=0;const n=setInterval((()=>{t++;const s=!!window.__TerminalCanvas,i=!!window.__netGrid;s&&i&&(this.api.terminal=window.__TerminalCanvas,this.api.netGrid=window.__netGrid,this.api.audio=window.audioManager||{playSystemSound:()=>{}},this.state.apiReady=!0,clearInterval(n),e()),t>=50&&(clearInterval(n),e())}),100)}))}async loadData(){if(!this.state.apiReady)return;const e=this.api.terminal.commandsList||this.api.terminal.commands||["help","syst","syslog","subj","dscr","notes","clear","reset","net_check","deg","vigil999","alpha","gamma","beta"];this.state.commands=e.map(String);const t=this.api.terminal.dossiers||{};this.state.dossierIds=Object.keys(t).map(String)}generateUI(){this.elements.panelContent&&(this.generateCommandButtons(),this.bindUI())}generateCommandButtons(){if([{cmd:"help",label:"help"},{cmd:"syst",label:"syst"},{cmd:"syslog",label:"syslog"},{cmd:"subj",label:"subj"},{cmd:"notes",label:"notes"},{cmd:"clear",label:"clear"},{cmd:"reset",label:"reset",danger:!0}].forEach((e=>{const t=this.createButton(e.label,(()=>{this.playSound("click"),"reset"===e.cmd?(this.executeCommand("reset"),this.showConfirmation("Подтвердить сброс? (Y/N)",(e=>{e?document.dispatchEvent(new KeyboardEvent("keydown",{key:"y"})):document.dispatchEvent(new KeyboardEvent("keydown",{key:"n"}))}))):this.executeCommand(e.cmd)}),e.danger);this.elements.panelContent.appendChild(t)})),this.state.dossierIds.length>0){const e=this.createButton("dscr ▶",(()=>this.openDscrPanel()));this.elements.panelContent.appendChild(e)}const e=this.createButton("trace ▶",(()=>this.openTraceMenu()));this.elements.panelContent.appendChild(e);const t=this.createButton("open ▶",(()=>this.openNoteMenu()));this.elements.panelContent.appendChild(t);const n=this.createButton("decrypt ▶",(()=>this.openDecryptMenu()));this.elements.panelContent.appendChild(n);if(this.getAudioIds().length>0){const e=this.createButton("playaudio ▶",(()=>this.openAudioMenu()));this.elements.panelContent.appendChild(e)}const s=this.createButton("esc",(()=>{this.playSound("click");const e=new KeyboardEvent("keydown",{key:"Escape"});document.dispatchEvent(e)}));s.style.color="#FF4444",s.style.borderColor="rgba(255, 80, 80, 0.25)",this.elements.panelContent.appendChild(s);const i=document.createElement("div");i.className="spacer",this.elements.panelContent.appendChild(i)}getAudioIds(){const e=this.api.terminal.dossiers||{};return Object.keys(e).filter((t=>e[t].audio))}getNoteIds(){return["NOTE_001","NOTE_002","NOTE_003","NOTE_004","NOTE_005"]}getTraceTargets(){return[{value:"0x9a0",label:"0x9a0"},{value:"0x095",label:"0x095"},{value:"signal",label:"SIGNAL"},{value:"phantom",label:"PHANTOM"},{value:"monolith",label:"MONOLITH"}]}createButton(t,n,s=!1){const i=document.createElement("button");return i.className=s?"cmd danger":"cmd",i.textContent=t,i.style.minHeight=`${e}px`,i.style.fontFamily="'Press Start 2P', monospace",i.addEventListener("click",(()=>{this.playSound("click"),n()})),i}bindUI(){this.elements.panelHandle.addEventListener("click",(()=>{this.elements.sidePanel.classList.toggle("collapsed")})),document.getElementById("gridClose").addEventListener("click",(()=>{this.closeGridModal()}))}showConfirmation(e,t){this.confirmationPanel.show(e,t)}openDscrPanel(){const e=this.state.dossierIds.map((e=>({value:e,label:e.toLowerCase()})));this.selectionPanel.show(e,"ВЫБЕРИТЕ ДОСЬЕ",(e=>this.executeCommand(`dscr ${e}`)))}openTraceMenu(){this.selectionPanel.show(this.getTraceTargets(),"ВЫБЕРИТЕ ЦЕЛЬ ДЛЯ TRACE",(e=>this.executeCommand(`trace ${e}`)))}openNoteMenu(){const e=this.getNoteIds().map((e=>({value:e,label:e.toLowerCase()})));this.selectionPanel.show(e,"ВЫБЕРИТЕ NOTE ФАЙЛ",(e=>this.executeCommand(`open ${e}`)))}openDecryptMenu(){this.selectionPanel.show([{value:"0XA71",label:"0xa71"},{value:"0XB33",label:"0xb33"},{value:"0XC44",label:"0xc44"},{value:"0XD22",label:"0xd22"},{value:"0XE09",label:"0xe09"},{value:"CORE",label:"core"}],"ВЫБЕРИТЕ ФАЙЛ ДЛЯ РАСШИФРОВКИ",(e=>this.executeCommand(`decrypt ${e}`)))}openAudioMenu(){const e=this.getAudioIds().map((e=>({value:e,label:e.toLowerCase()})));0!==e.length?this.selectionPanel.show(e,"ВЫБЕРИТЕ АУДИОЗАПИСЬ",(e=>this.executeCommand(`playaudio ${e}`))):this.addColoredText("ОШИБКА: Нет доступных аудиозаписей","#FF4444")}setupDecryptListener(){setInterval((()=>{window.__TerminalCanvas?.isDecryptActive?.()?this.numericKeypad.isOpen||this.numericKeypad.show():this.numericKeypad.isOpen&&this.numericKeypad.hide()}),200)}executeCommand(e){this.api.terminal?.processCommand&&this.api.terminal.processCommand(e)}addColoredText(e,t="#00FF41"){this.api.terminal&&this.api.terminal.addColoredText(e,t,!0)}addInputLine(){this.api.terminal&&this.api.terminal.addInputLine()}hideNetGridInitially(){const e=document.querySelector("canvas:not(#terminalCanvas)");e&&(e.style.display="none")}openGridModal(){this.api.netGrid.setGridMode(!0),this.elements.gridModal.classList.remove("hidden");const e=document.querySelector("canvas:not(#terminalCanvas)");e&&this.elements.mapContainer&&(e.style.display="block",this.elements.mapContainer.appendChild(e)),this.playSound("open"),this.executeCommand("net_mode")}closeGridModal(){this.api.netGrid.setGridMode(!1),this.elements.gridModal.classList.add("hidden");const e=document.querySelector("canvas:not(#terminalCanvas)");e&&(e.style.display="none",document.body.appendChild(e)),this.playSound("close")}playSound(e){this.api.audio?.playSystemSound&&this.api.audio.playSystemSound(e)}}function a(){const e=document.getElementById("mobileWarning1"),t=document.getElementById("mobileWarning2"),n=document.getElementById("okBtn1"),s=document.getElementById("okBtn2"),i=document.getElementById("terminal"),a=document.getElementById("sidePanel");e.classList.remove("hidden"),n.onclick=()=>{e.classList.add("hidden"),setTimeout((()=>{t.classList.remove("hidden")}),100)},s.onclick=()=>{t.classList.add("hidden"),i.style.opacity="1",a.style.opacity="1",window.__MobileTerminal.start()}}document.addEventListener("DOMContentLoaded",(()=>{const e=new i;window.__MobileTerminal=e,setTimeout(a,200)}))})();
