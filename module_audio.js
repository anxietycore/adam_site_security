class e{constructor(){this.audioContext=null,this.soundCache=new Map,this.activeSounds=new Map,this.lastKeyPressSound=null,this.basePath="sounds/",this.categories={ambient:"ambient/",interface:"interface/",commands:"commands/",grid:"grid/",operations:"operations/",system:"system/",vigil:"vigil/",voices:"voices/",dossiers:"dossiers/"},this.backgroundSources=new Map,this.effectsVolume=1,this.backgroundVolume=.2,this.glitchBackgroundVolume=.3,this.init()}async init(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){}}async loadSound(e,t){const s=this.basePath+this.categories[e]+t;if(this.soundCache.has(s))return this.soundCache.get(s);try{const e=await fetch(s);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.arrayBuffer(),o=await this.audioContext.decodeAudioData(t);return this.soundCache.set(s,o),o}catch(e){const t=new Audio(s);return t.preload="auto",t.load(),this.soundCache.set(s,{type:"html5",element:t}),{type:"html5",element:t}}}async preloadCriticalSounds(){const e=[["ambient","ambient_terminal.mp3"],["ambient","ambient_glitch.mp3"],["interface","interface_key_press_01.mp3"],["interface","interface_key_press_02.mp3"],["interface","interface_key_press_03.mp3"],["interface","interface_key_press_04.mp3"],["system","system_glitch_e.mp3"],["system","system_glitch_error.mp3"]];for(const[t,s]of e)await this.loadSound(t,s)}async playSound(e,t,s={}){this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume();const o=this.basePath+this.categories[e]+t;let a=this.soundCache.get(o);return a||(a=await this.loadSound(e,t)),a?"html5"===a.type?this.playHTML5Sound(a.element,s):this.playWebAudio(a,s):null}playWebAudio(e,t){if(!this.audioContext||!e)return null;try{const s=this.audioContext.createBufferSource();s.buffer=e;const o=this.audioContext.createGain(),a=void 0!==t.volume?t.volume:this.effectsVolume;o.gain.value=a,t.playbackRate&&(s.playbackRate.value=t.playbackRate),s.connect(o),o.connect(this.audioContext.destination),s.start(0,t.startTime||0);const n=Date.now()+Math.random();return this.activeSounds.set(n,s),s.onended=()=>{this.activeSounds.delete(n)},{id:n,stop:()=>{try{s.stop(),this.activeSounds.delete(n)}catch(e){}},setVolume:e=>{o.gain.value=e},setPlaybackRate:e=>{s.playbackRate&&(s.playbackRate.value=e)},source:s,_isWebAudio:!0}}catch(e){return null}}playHTML5Sound(e,t){try{const s=e.cloneNode(),o=void 0!==t.volume?t.volume:this.effectsVolume;s.volume=o,s.loop=t.loop||!1,t.playbackRate&&(s.playbackRate=t.playbackRate),t.startTime&&(s.currentTime=t.startTime),s.play().catch((()=>{}));const a=Date.now()+Math.random();return this.activeSounds.set(a,s),t.loop||(s.onended=()=>{this.activeSounds.delete(a)}),{id:a,stop:()=>{s.pause(),s.currentTime=0,this.activeSounds.delete(a)},setVolume:e=>{s.volume=e},element:s}}catch(e){return null}}stopSound(e){e&&e.stop&&e.stop()}stopAllEffects(){this.activeSounds.forEach(((e,t)=>{e._isBackground||(e.stop?e.stop():e.pause&&e.pause(),this.activeSounds.delete(t))}))}async playAmbientSeamless(e,t=.2){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.audioContext.state&&await this.audioContext.resume();const s="sounds/ambient/ambient_terminal.mp3";try{const o=await fetch(s);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const a=await o.arrayBuffer(),n=await this.audioContext.decodeAudioData(a),i=this.backgroundSources.get(e);i&&i.stop&&(i.stop(),this.backgroundSources.delete(e));const r=this.audioContext.createBufferSource();r.buffer=n,r.loop=!0,r.loopStart=0,r.loopEnd=n.duration;const c=this.audioContext.createGain();c.gain.value=t,r.connect(c),c.connect(this.audioContext.destination);const u=this.audioContext.currentTime+.05;r.start(u);const l={id:Date.now(),source:r,gainNode:c,stop:()=>{try{r&&(r.stop(),r.disconnect()),c&&c.disconnect()}catch(e){}},setVolume:e=>{c&&(c.gain.value=e)},_isBackground:!0};return this.backgroundSources.set(e,l),l}catch(o){try{return await this.loadAmbientViaXHR(s,e,t)}catch(e){}return null}}async loadAmbientViaXHR(e,t,s){return new Promise(((o,a)=>{const n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=async()=>{if(200===n.status)try{const e=n.response,a=await this.audioContext.decodeAudioData(e),i=this.audioContext.createBufferSource();i.buffer=a,i.loop=!0,i.loopStart=0,i.loopEnd=a.duration;const r=this.audioContext.createGain();r.gain.value=s,i.connect(r),r.connect(this.audioContext.destination),i.start(0);const c={id:Date.now(),source:i,gainNode:r,stop:()=>{try{i.stop(),i.disconnect(),r.disconnect()}catch(e){}},setVolume:e=>{r.gain.value=e},_isBackground:!0};this.backgroundSources.set(t,c),o(c)}catch(e){a(e)}else a(new Error(`XHR Status: ${n.status}`))},n.onerror=()=>{a(new Error("XHR Network Error"))},n.send()}))}async startBackgroundMusic(e=!1){const t=e?"ambient_glitch.mp3":"ambient_terminal.mp3",s=e?this.glitchBackgroundVolume:this.backgroundVolume;this.backgroundSources.has(t)&&this.stopBackgroundMusic(t);const o=await this.playSound("ambient",t,{volume:s,loop:!0});return o?(o._isBackground=!0,this.backgroundSources.set(t,o),o):null}stopBackgroundMusic(e=null){if(e){const t=this.backgroundSources.get(e);t&&(this.stopSound(t),this.backgroundSources.delete(e))}else this.backgroundSources.forEach((e=>{this.stopSound(e)})),this.backgroundSources.clear()}setBackgroundVolume(e,t){const s=this.backgroundSources.get(e);s&&s.setVolume&&s.setVolume(t)}playKeyPress(e="generic"){let t;switch(e.toLowerCase()){case"backspace":t="interface_key_press_backspace.mp3";break;case"enter":t="interface_key_press_enter.mp3";break;case"space":t="interface_key_press_space.mp3";break;case"escape":t="interface_key_press_esc.mp3";break;case"shift":t="interface_key_press_shift.mp3";break;case"ctrl":t="interface_key_press_ctrl.mp3";break;case"alt":t="interface_key_press_alt.mp3";break;case"capslock":t="interface_key_press_capslock.mp3";break;case"generic":const e=["interface_key_press_01.mp3","interface_key_press_02.mp3","interface_key_press_03.mp3","interface_key_press_04.mp3"];let s=e.filter((e=>e!==this.lastKeyPressSound));0===s.length&&(s=e),t=s[Math.floor(Math.random()*s.length)],this.lastKeyPressSound=t;break;default:t="interface_key_press_01.mp3"}return this.playSound("interface",t,{volume:.7})}playGridSound(e){switch(e){case"move":return this.playSound("grid","grid_move.wav",{volume:.5});case"select":return this.playSound("grid","grid_select.wav",{volume:.6});case"lock":return this.playSound("grid","grid_lock.wav",{volume:.7});case"unlock":return this.playSound("grid","grid_unlock.wav",{volume:.7});default:return null}}playCommandSound(e){switch(e){case"info":return this.playSound("commands","commands_info.mp3",{volume:.7});case"navigate":return this.playSound("commands","commands_navigate.mp3",{volume:.7});case"system":return this.playSound("commands","commands_system.mp3",{volume:.7});case"error":return this.playSound("commands","commands_error.mp3",{volume:.8});default:return null}}async playOperationSound(e){switch(e){case"start":return await this.playSound("operations","operations_start.mp3",{volume:.7});case"decrypt_success":return await this.playSound("operations","operations_decrypt_success.mp3",{volume:.85});case"decrypt_failure":return await this.playSound("operations","operations_decrypt_failure.mp3",{volume:.85});case"trace_scan":return await this.playSound("operations","operations_trace_scan.mp3",{volume:.75,loop:!0});case"trace_complete":return await this.playSound("operations","operations_trace_complete.mp3",{volume:.75});case"process":return await this.playSound("operations","operations_process.mp3",{volume:.7});default:return null}}playSystemSound(e,t={}){const s={glitch_e:["system","system_glitch_e.mp3",.9],glitch_error:["system","system_glitch_error.mp3",.7],reset_com:["system","system_reset_com.mp3",.7],reset_com_reverse:["system","system_reset_com_reverse.mp3",.7],connection_loss:["system","system_connection_loss.mp3",.6],random_glitch:["system","system_random_glitch.mp3",.4],Y:["system","system_Y.mp3",.7],N:["system","system_N.mp3",.7],reset:["system","system_reset.mp3",.7],glitch_text:["system","system_glitch_text.mp3",.5]};if(s[e]){const[o,a,n]=s[e],i=void 0!==t.volume?t.volume:n,r=this.playSound(o,a,{volume:i,playbackRate:t.playbackRate,loop:t.loop});return"glitch_text"===e&&t.playbackRate&&r&&r.setPlaybackRate&&r.setPlaybackRate(t.playbackRate),r}return null}playVigilSound(e){switch(e){case"confirm":return this.playSound("vigil","vigil_confirm.mp3",{volume:.8});case"key_accept":return this.playSound("vigil","vigil_key_accept.mp3",{volume:.75});case"question":return this.playSound("vigil","vigil_question.mp3",{volume:.7});case"transition":return this.playSound("vigil","vigil_transition.mp3",{volume:.5});default:return null}}playVoiceSound(e){const t={adam_02:["voices","voices_adam_02.mp3",.3],adam_03:["voices","voices_adam_03.mp3",.3],whisper_01:["voices","voices_whisper_01.mp3",.3],whisper_02:["voices","voices_whisper_02.mp3",.3],whisper_03:["voices","voices_whisper_03.mp3",.3]};if(t[e]){const[s,o,a]=t[e];return this.playSound(s,o,{volume:a})}return null}playDossierSound(e){const t={"0X001":"dscr_erich_van_koss.mp3","0X095":"dscr_subject_095.mp3","0X413":"dscr_alien_biosphere.mp3","0X811":"dscr_sigma_prototype.mp3","0X9A0":"dscr_blackhole_loop.mp3","0XT00":"dscr_operator_T00.mp3","0XF00":"dscr_subject_phantom.mp3"}[e];return t?this.playSound("dossiers",t,{volume:.8}):null}playInterfaceTransition(e=!0){const t=e?"interface_mode_to_grid.mp3":"interface_mode_to_terminal.mp3";return this.playSound("interface",t,{volume:.8})}playInterfaceResult(e=!0){const t=e?"interface_key_success.mp3":"interface_key_reject.mp3",s=e?.7:.8;return this.playSound("interface",t,{volume:s})}setEffectsVolume(e){this.effectsVolume=Math.max(0,Math.min(1,e))}setBackgroundMusicVolume(e){this.backgroundVolume=Math.max(0,Math.min(1,e)),this.backgroundSources.forEach(((t,s)=>{t.setVolume&&!s.includes("glitch")&&t.setVolume(e)}))}pauseAll(){this.audioContext&&"running"===this.audioContext.state&&this.audioContext.suspend()}resumeAll(){this.audioContext&&"suspended"===this.audioContext.state&&this.audioContext.resume()}}"undefined"!=typeof module&&module.exports?module.exports=e:window.AudioManager=e;
